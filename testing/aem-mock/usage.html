
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2022-01-04
 Rendered using Reflow Maven Skin 1.1.0 (https://github.com/wcm-io/wcm-io-tooling/tree/develop/maven/skins/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

  <head>
    <meta charset="UTF-8" />
    <title>Usage | AEM Mocks</title>

    <link rel="shortcut icon" href="https://wcm.io/images/favicon.ico">
    <link rel="apple-touch-icon" href="https://wcm.io/images/favicon-152.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="wcm.io - Libraries and extensions for AEM applications" />
    <meta http-equiv="content-language" content="en" />

    <link href="https://wcm.io/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://wcm.io/css/docs.css" rel="stylesheet" />
    <link href="https://wcm.io/css/reflow-skin.css" rel="stylesheet" />
    <link href="https://wcm.io/css/highlightjs-style-github.min.css" rel="stylesheet" />

    <link href="https://wcm.io/css/lightbox.css" rel="stylesheet" />

    <link href="https://wcm.io/css/site.css" rel="stylesheet" />
    <link href="https://wcm.io/css/print.css" rel="stylesheet" media="print" />


  </head>

  <body class="page-usage project-io.wcm.testing.aem-mock.root" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../..">wcm.io</a>
          <div class="nav-collapse collapse" id="top-nav-collapse">
            <ul class="nav pull-right">
              <li ><a href="https://github.com/wcm-io" title="GitHub project" class="externalLink">GitHub project</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Categories <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li ><a href="../../wcm/" title="WCM">WCM</a></li>
                  <li ><a href="../../dam/" title="DAM">DAM</a></li>
                  <li ><a href="../../caconfig/" title="Context-Aware Configuration">Context-Aware Configuration</a></li>
                  <li ><a href="../../handler/" title="Handler">Handler</a></li>
                  <li ><a href="../../sling/" title="Sling">Sling</a></li>
                  <li ><a href="../" title="Testing">Testing</a></li>
                  <li ><a href="../../samples/" title="Samples">Samples</a></li>
                  <li ><a href="../../tooling/" title="Tooling">Tooling</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contribute <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li ><a href="../../contribute.html" title="Contribute">Contribute</a></li>
                  <li ><a href="../../manifest.html" title="Manifest">Manifest</a></li>
                  <li ><a href="https://wcm-io.atlassian.net" title="Issues" class="externalLink">Issues</a></li>
                  <li ><a href="https://wcm-io.atlassian.net/wiki/" title="Wiki" class="externalLink">Wiki</a></li>
                  <li ><a href="../../mailing-lists.html" title="Mailing Lists">Mailing Lists</a></li>
                  <li ><a href="https://github.com/wcm-io" title="Fork on GitHub" class="externalLink">Fork on GitHub</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  <div class="container">

  <!-- Masthead
  ================================================== -->

  <header>
  <div class="jumbotron subhead">
    <div class="row" id="banner">
      <div class="span12">
        <div class="pull-left">
          <a href="../../" id="bannerLeft"><h1><img src="https://wcm.io/images/favicon-16@3x.png"/> wcm.io</h1></a>
          <p class="lead">Libraries and extensions for AEM applications</p>
        </div>
        <div class="pull-right">
        </div>
      </div>
    </div>
  </div>
    <div>
      <ul class="breadcrumb">
        <li><a href="../../" title="wcm.io">wcm.io</a></li>
        <li class="divider">/</li>
        <li><a href="../index.html" title="Testing">Testing</a></li>
        <li class="divider">/</li>
        <li><a href="index.html" title="AEM Mocks">AEM Mocks</a></li>
        <li class="divider">/</li>
        <li>Usage</li>
      </ul>
    </div>
  </header>

  <div class="main-body">
  <div class="row">
    <div class="span8">
      <div class="body-content">
<section> 
 <div class="page-header">
  <h2 id="Usage">Usage</h2>
 </div> 
 <p>The <code>AemContext</code> object provides access to mock implementations of:</p> 
 <ul> 
  <li>OSGi Component Context</li> 
  <li>OSGi Bundle Context</li> 
  <li>Sling Resource Resolver</li> 
  <li>Sling Request</li> 
  <li>Sling Response</li> 
  <li>Sling Script Helper</li> 
 </ul> 
 <p>Additionally it supports:</p> 
 <ul> 
  <li>Registering OSGi services</li> 
  <li>Registering adapter factories</li> 
  <li>Accessing JSON Importer</li> 
 </ul> 
 <section> 
  <h3 id="JUnit_5_AEM_Context_JUnit_Extension">JUnit 5: AEM Context JUnit Extension</h3> 
  <p>The AEM mock context can be injected into a JUnit test using a custom JUnit extension named <code>AemContextExtension</code>. This extension takes care of all initialization and cleanup tasks required to make sure all unit tests can run independently (and in parallel, if required).</p> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>@ExtendWith(AemContextExtension.class)
public class ExampleTest {

  private final AemContext context = new AemContext();

  @Test
  public void testSomething() {
    Resource resource = context.resourceResolver().getResource("/content/sample/en");
    Page page = resource.adaptTo(Page.class);
    // further testing
  }

}

</pre> 
   </div> 
  </div> 
  <p>It is possible to combine such a unit test with a <code>@ExtendWith</code> annotation e.g. for <a class="externalLink" href="https://www.javadoc.io/page/org.mockito/mockito-junit-jupiter/latest/org/mockito/junit/jupiter/MockitoExtension.html">Mockito JUnit Jupiter Extension</a>.</p> 
  <p>It is recommended to define the AemContext field as non-static field and use <code>@BeforeEach</code> and <code>@AfterEach</code> methods if you want to execute setup or tear down code for each test run. Since version 3.0.0 AEM Mocks also supports static AemContext fields and <code>@BeforeAll</code> and <code>@AfterAll</code> methods. However, you have to make sure you have no side-effects between the tests, as all changes in the AemContext object (e.g. content written to repository or OSGi services registered) are visible to all tests in the class.</p> 
 </section> 
 <section> 
  <h3 id="JUnit_4_AEM_Context_JUnit_Rule">JUnit 4: AEM Context JUnit Rule</h3> 
  <p>The AEM mock context can be injected into a JUnit test using a custom JUnit rule named <code>AemContext</code>. This rule takes care of all initialization and cleanup tasks required to make sure all unit tests can run independently (and in parallel, if required).</p> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>public class ExampleTest {

  @Rule
  public final AemContext context = new AemContext();

  @Test
  public void testSomething() {
    Resource resource = context.resourceResolver().getResource("/content/sample/en");
    Page page = resource.adaptTo(Page.class);
    // further testing
  }

}

</pre> 
   </div> 
  </div> 
  <p>It is possible to combine such a unit test with a <code>@RunWith</code> annotation e.g. for <a class="externalLink" href="https://www.javadoc.io/page/org.mockito/mockito-core/latest/org/mockito/junit/MockitoJUnitRunner.html">Mockito JUnit Runner</a>.</p> 
 </section> 
 <section> 
  <h3 id="Choosing_Resource_Resolver_Mock_Type">Choosing Resource Resolver Mock Type</h3> 
  <p>The AEM mock context supports different resource resolver types (provided by the <a class="externalLink" href="https://sling.apache.org/documentation/development/sling-mock.html">Sling Mocks</a> implementation). Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>private final AemContext context = new AemContext(ResourceResolverType.RESOURCERESOLVER_MOCK);

</pre> 
   </div> 
  </div> 
  <p>Different resource resolver mock types are supported with pros and cons, see <a class="externalLink" href="https://sling.apache.org/documentation/development/sling-mock.html#resource-resolver-types">Resource Resolver Types</a> for details.</p> 
  <p>It is even possible to supply multiple resource resolver types in the constructor argument - in this case the unit test is run multiple times, once for each type. But this is only relevant if you want to develop your own unit test support components that should be compatible with all resource resolver types. Normally you pick just one type which fits best for your testing needs.</p> 
 </section> 
 <section> 
  <h3 id="Getting_and_Manipulating_Pages">Getting and Manipulating Pages</h3> 
  <p>Example for accessing AEM API for reading and writing data:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>@ExtendWith(AemContextExtension.class)
public class ExampleTest {

  private final AemContext context = new AemContext();

  @Test
  public void testSomething() {
    Page page = context.pageManager().getPage("/content/sample/en");
    Template template = page.getTemplate();
    Iterator&lt;Page&gt; childPages = page.listChildren();
    // further testing
  }

  @Test
  public void testPageManagerOperations() throws WCMException {
    Page page = context.pageManager().create("/content/sample/en", "test1",
        "/apps/sample/templates/homepage", "title1");
    // further testing
    context.pageManager().delete(page, false);
  }

}

</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Simulating_Sling_Request">Simulating Sling Request</h3> 
  <p>Example for preparing a sling request with custom request data:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>// prepare sling request
context.request().setQueryString("param1=aaa&amp;param2=bbb");

context.requestPathInfo().setSelectorString("selector1.selector2");
context.requestPathInfo().setExtension("html");

// set current page
context.currentPage("/content/sample/en");

// set WCM Mode
WCMMode.EDIT.toRequest(context.request());
</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Registering_OSGi_service">Registering OSGi service</h3> 
  <p>Example for registering and getting an OSGi service for a unit test:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>// register OSGi service
context.registerService(MyClass.class, myService);

// or alternatively: inject dependencies, activate and register OSGi service
context.registerInjectActivateService(myService);

// get OSGi service
MyClass service = context.getService(MyClass.class);

// or alternatively: get OSGi service via bundle context
ServiceReference ref = context.bundleContext().getServiceReference(MyClass.class.getName());
MyClass service2 = context.bundleContext().getService(ref);
</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Adapter_Factories">Adapter Factories</h3> 
  <p>You can register your own or existing adapter factories to support adaptions e.g. for classes extending <code>SlingAdaptable</code>.</p> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>// register adapter factory
context.registerService(myAdapterFactory);

// test adaption
MyClass object = resource.adaptTo(MyClass.class);
</pre> 
   </div> 
  </div> 
  <p>You do not have to care about cleaning up the registrations - this is done automatically by the <code>AemContext</code> rule.</p> 
 </section> 
 <section> 
  <h3 id="Sling_Models">Sling Models</h3> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>@Before
public void setUp() {
  // register models from package
  context.addModelsForPackage("com.app1.models");
}

@Test
public void testSomething() {
  RequestAttributeModel model = context.request().adaptTo(RequestAttributeModel.class);
  // further testing
}

@Model(adaptables = SlingHttpServletRequest.class)
interface RequestAttributeModel {
  @Inject
  String getProp1();
}
</pre> 
   </div> 
  </div> 
  <p><i>Note:</i> If your model is not adaptable from SlingHttpServletRequest.class (e.g. only from Resource.class) and you rely on the extra features provided by <a class="externalLink" href="https://wcm.io/sling/commons/">wcm.io Sling Commons</a> and <a class="externalLink" href="https://wcm.io/sling/models/">wcm.io Sling Models</a> which can inject request-derived objects via a ThreadLocal it might be necessary to set the request context manually to ensure injection of request-derived objects works in your unit tests. Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>MockSlingExtensions.setRequestContext(context, context.request());
</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Content_Policies">Content Policies</h3> 
  <p>AEM Mock does not implement the full stack with editable templates, policy mappings and policies stored in the repository. But it provides a shortcut way to quickly provide a content policy with some properties for any resource type, and ensures these properties can be read either via Style objects or via the Content Policy API.</p> 
  <p>Example for setting a content policy for a resource type:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>// create a content policy with mapping for resource type
context.contentPolicyMapping("app1/componenty/component1",
    "prop1", "value1",
    "prop2", 123);
</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Setting_run_modes">Setting run modes</h3> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>// set runmode for unit test
context.runMode("author");
</pre> 
   </div> 
  </div> 
  <p>This sets the current run mode(s) in a mock version of <code>SlingSettingsService</code>.</p> 
 </section> 
 <section> 
  <h3 id="Application-specific_AEM_context">Application-specific AEM context</h3> 
  <p>When building unit test suites for your AEM application you have usually to execute always some application-specific preparation tasks, e.g. register custom services, adapter factories or import sample content. This can be done in a convenience class using a <code>SetupCallback</code>. Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>public final class AppAemContext {

  public static AemContext newAemContext() {
    return new AemContext(new SetUpCallback());
  }

  private static final class SetUpCallback implements AemContextCallback {

    @Override
    public void execute(AemContext context) throws PersistenceException, IOException {

      // application-specific services for unit tests
      context.registerService(AdapterFactory.class, new AppAdapterFactory());
      context.registerService(new AemObjectInjector());

      // import sample content
      context.contentLoader().json("/sample-content.json", "/content/sample/en");

      // set default current page
      context.currentPage("/content/sample/en");
    }

  }

}
</pre> 
   </div> 
  </div> 
  <p>In the unit test you can use this customized AEM context:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>@ExtendWith(AemContextExtension.class)
public class MyTest {

  private final AemContext context = AppAemContext.newAemContext();

  @Test
  public void testSomething() {
    // do test
  }

}
</pre> 
   </div> 
  </div> 
 </section> 
 <section> 
  <h3 id="Context_Plugins">Context Plugins</h3> 
  <p>AEM Mocks supports “Context Plugins” that hook into the lifecycle of each test run and can prepare test setup before or after the other setUp actions, and execute test tear down code before or after the other tearDown action.</p> 
  <p>To define a plugin implement the <code>org.apache.sling.testing.mock.osgi.context.ContextPlugin&lt;AemContextImpl&gt;</code> interface. For convenience it is recommended to extend the abstract class <code>org.apache.sling.testing.mock.osgi.context.AbstractContextPlugin&lt;AemContextImpl&gt;</code>. In most cases you would just override the <code>afterSetUp</code> method. In this method you can register additional OSGi services or do other preparation work. It is recommended to define a constant pointing to a singleton of a plugin instance for using it.</p> 
  <p>To use a plugin in your unit test class, use the <code>AemContextBuilder</code> class instead of directly instantiating the <code>AemContext</code>class. This allows you in a fluent style to configure more options, with the <code>plugin(...)</code> method you can add one or more plugins.</p> 
  <p>Example:</p> 
  <div class="source"> 
   <div class="source"> 
    <pre>AemContext context = new AemContextBuilder().plugin(MY_PLUGIN).build();
</pre> 
   </div> 
  </div> 
  <p>More examples:</p> 
  <ul> 
   <li><a class="externalLink" href="https://github.com/wcm-io/wcm-io-testing/blob/develop/wcm-io-mock/sling/src/main/java/io/wcm/testing/mock/wcmio/sling/ContextPlugins.java">wcm.io Sling Extensions Mock Helper</a></li> 
   <li><a class="externalLink" href="https://github.com/wcm-io/wcm-io-testing/blob/develop/wcm-io-mock/sling/src/test/java/io/wcm/testing/mock/wcmio/sling/MockSlingExtensionsTest.java">wcm.io Sling Extensions Mock Helper Test</a></li> 
  </ul> 
 </section> 
</section>
      </div>
    </div>
    <div class="span4">
      <div id="toc-sidebar">
        <div class="well">
          <ul class="nav nav-list">
            <li class="nav-header">Table of Contents</li>
    <li class="dropdown"><a href="#Usage" title="Usage">Usage <b class="caret"></b></a>
      <ul class="nav nav-list">
    <li><a href="#JUnit_5_AEM_Context_JUnit_Extension" title="JUnit 5: AEM Context JUnit Extension">JUnit 5: AEM Context JUnit Extension</a>
    <li><a href="#JUnit_4_AEM_Context_JUnit_Rule" title="JUnit 4: AEM Context JUnit Rule">JUnit 4: AEM Context JUnit Rule</a>
    <li><a href="#Choosing_Resource_Resolver_Mock_Type" title="Choosing Resource Resolver Mock Type">Choosing Resource Resolver Mock Type</a>
    <li><a href="#Getting_and_Manipulating_Pages" title="Getting and Manipulating Pages">Getting and Manipulating Pages</a>
    <li><a href="#Simulating_Sling_Request" title="Simulating Sling Request">Simulating Sling Request</a>
    <li><a href="#Registering_OSGi_service" title="Registering OSGi service">Registering OSGi service</a>
    <li><a href="#Adapter_Factories" title="Adapter Factories">Adapter Factories</a>
    <li><a href="#Sling_Models" title="Sling Models">Sling Models</a>
    <li><a href="#Content_Policies" title="Content Policies">Content Policies</a>
    <li><a href="#Setting_run_modes" title="Setting run modes">Setting run modes</a>
    <li><a href="#Application-specific_AEM_context" title="Application-specific AEM context">Application-specific AEM context</a>
    <li><a href="#Context_Plugins" title="Context Plugins">Context Plugins</a>
        <li class="divider"></li>
      </ul>
    </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  </div>

  </div>

  <!-- Footer
  ================================================== -->
  <footer class="well">
    <div class="container">
      <div class="row">
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Main</li>
            <li >
              <a href="../../" title="Home">Home</a>
            </li>
            <li >
              <a href="../../platforms.html" title="Platforms">Platforms</a>
            </li>
            <li >
              <a href="../../maven.html" title="Maven Repositories">Maven Repositories</a>
            </li>
            <li >
              <a href="https://github.com/wcm-io" title="GitHub project" class="externalLink">GitHub project</a>
            </li>
            <li >
              <a href="../../subprojects.html" title="Subprojects">Subprojects</a>
            </li>
            <li >
              <a href="http://www.apache.org/licenses/LICENSE-2.0.txt" title="License" class="externalLink">License</a>
            </li>
            <li >
              <a href="../../commercial-support.html" title="Commercial Support">Commercial Support</a>
            </li>
            <li >
              <a href="https://diva-e.com/en/imprint/" title="Imprint" class="externalLink">Imprint</a>
            </li>
            <li >
              <a href="../../privacy.html" title="Privacy Policy">Privacy Policy</a>
            </li>
          </ul>
        </div>
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Categories</li>
            <li >
              <a href="../../wcm/" title="WCM">WCM</a>
            </li>
            <li >
              <a href="../../dam/" title="DAM">DAM</a>
            </li>
            <li >
              <a href="../../caconfig/" title="Context-Aware Configuration">Context-Aware Configuration</a>
            </li>
            <li >
              <a href="../../handler/" title="Handler">Handler</a>
            </li>
            <li >
              <a href="../../sling/" title="Sling">Sling</a>
            </li>
            <li >
              <a href="../" title="Testing">Testing</a>
            </li>
            <li >
              <a href="../../samples/" title="Samples">Samples</a>
            </li>
            <li >
              <a href="../../tooling/" title="Tooling">Tooling</a>
            </li>
          </ul>
        </div>
        <div class="span2 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Contribute</li>
            <li >
              <a href="../../contribute.html" title="Contribute">Contribute</a>
            </li>
            <li >
              <a href="../../manifest.html" title="Manifest">Manifest</a>
            </li>
            <li >
              <a href="https://wcm-io.atlassian.net" title="Issues" class="externalLink">Issues</a>
            </li>
            <li >
              <a href="https://wcm-io.atlassian.net/wiki/" title="Wiki" class="externalLink">Wiki</a>
            </li>
            <li >
              <a href="../../mailing-lists.html" title="Mailing Lists">Mailing Lists</a>
            </li>
            <li >
              <a href="https://github.com/wcm-io" title="Fork on GitHub" class="externalLink">Fork on GitHub</a>
            </li>
          </ul>
        </div>
        <div class="span3 bottom-nav">
          <ul class="nav nav-list">
            <li class="nav-header">Maven documentation</li>
            <li >
              <a href="project-info.html" title="Project Information">Project Information <i class="icon-chevron-right"></i></a>
            </li>
            <li >
              <a href="project-reports.html" title="Project Reports">Project Reports <i class="icon-chevron-right"></i></a>
            </li>
          </ul>
        </div>
        <div class="span3 bottom-description">
          <blockquote>wcm.io is an Open Source project which provides libraries and extensions for AEM-based applications.</blockquote>
        </div>
      </div>
    </div>
  </footer>

  <div class="container subfooter">
    <div class="row">
      <div class="span12">
        <p class="pull-right"><a href="#">Back to top</a></p>
        <p class="copyright">Copyright &copy;2014-2022 <a href="https://wcm.io">wcm.io</a>. All Rights Reserved.</p>
        <p class="version-date"><span class="projectVersion">Version: 4.1.9-SNAPSHOT. </span><span class="publishDate">Last Published: 2022-01-04. </span></p>
      </div>
    </div>
  </div>

  <!-- JavaScript
  ================================================== -->
  <script src="https://wcm.io/js/jquery.min.js"></script>
  <script src="https://wcm.io/js/bootstrap.min.js"></script>
  <script src="https://wcm.io/js/lightbox.min.js"></script>
  <script src="https://wcm.io/js/reflow-scroll.js"></script>
  <script src="https://wcm.io/js/highlight.min.js"></script>


  <script src="https://wcm.io/js/reflow-skin.js"></script>

  </body>
</html>